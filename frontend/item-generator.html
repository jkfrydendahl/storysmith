<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Item Generator - Storysmith</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <div class="back-link">
        <a href="index.html">‚Üê Back to Storysmith</a>
      </div>
      
      <h1>‚öîÔ∏è Item Generator</h1>
      <div class="tip">Fill in any fields you want to customize, or leave blank for random results.</div>
      
      <div class="form-grid">
        <div>
          <label for="item_type">Type</label>
          <input type="text" id="item_type" placeholder="weapon, armor, potion, artifact, tool, etc.">
        </div>
        <div>
          <label for="rarity">Rarity</label>
          <input type="text" id="rarity" placeholder="common, uncommon, rare, legendary">
        </div>
        <div>
          <label for="material">Material</label>
          <input type="text" id="material" placeholder="steel, wood, crystal, bone, silver, etc.">
        </div>
        <div>
          <label for="tone">Style</label>
          <input type="text" id="tone" placeholder="ornate, crude, mysterious, elegant, ancient, etc.">
        </div>
        <div>
          <label for="genre">Genre</label>
          <input type="text" id="genre" placeholder="fantasy, sci-fi, horror, steampunk, etc.">
        </div>
      </div>
      
      <button class="generate-btn" onclick="generateItem()">Generate Item</button>
      <div class="output waiting" id="output">Waiting for input... Click "Generate Item" to create an item.</div>
    </div>

    <script src="history.js"></script>
    <script>
      async function generateItem() {
        const itemType = document.getElementById('item_type').value;
        const rarity = document.getElementById('rarity').value;
        const material = document.getElementById('material').value;
        const style = document.getElementById('tone').value;
        const genre = document.getElementById('genre').value;
        const output = document.getElementById('output');
        const button = document.querySelector('.generate-btn');

        // Set loading state
        output.textContent = "üé≤ Crafting your item...";
        output.className = 'output loading';
        button.disabled = true;
        button.textContent = "Generating...";

        try {
          const params = new URLSearchParams({ 
            item_type: itemType, 
            rarity: rarity, 
            material: material, 
            style: style, 
            genre: genre 
          });
          const res = await fetch(`http://localhost:8000/item?${params}`);
          
          if (!res.ok) {
            const errorData = await res.json().catch(() => null);
            const errorMessage = errorData?.detail || `HTTP ${res.status}: ${res.statusText}`;
            throw new Error(errorMessage);
          }
          
          const data = await res.json();
          output.textContent = data.item;
          output.className = 'output';
          
          // Save to history
          HistoryManager.save('item', {
            type: itemType,
            rarity: rarity,
            material: material,
            style: style,
            genre: genre
          }, data.item);
          
        } catch (err) {
          output.textContent = `‚ùå ${err.message}`;
          output.className = 'output error';
          console.error('Generation error:', err);
        } finally {
          // Reset button state
          button.disabled = false;
          button.textContent = "Generate Item";
        }
      }

      // Add keyboard support
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !document.querySelector('.generate-btn').disabled) {
          generateItem();
        }
      });
    </script>
  </body>
</html>
